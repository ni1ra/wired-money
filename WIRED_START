#!/bin/bash
#
# WIRED_START - Single command to launch the complete WIRED system
#
# Usage:
#   ./WIRED_START
#   ./WIRED_START --install  # First-time setup
#
# Requirements:
#   - Node.js >= 18
#   - npm
#   - Claude CLI installed and authenticated
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo -e "${BLUE}"
echo "██╗    ██╗██╗██████╗ ███████╗██████╗ "
echo "██║    ██║██║██╔══██╗██╔════╝██╔══██╗"
echo "██║ █╗ ██║██║██████╔╝█████╗  ██║  ██║"
echo "██║███╗██║██║██╔══██╗██╔══╝  ██║  ██║"
echo "╚███╔███╔╝██║██║  ██║███████╗██████╔╝"
echo " ╚══╝╚══╝ ╚═╝╚═╝  ╚═╝╚══════╝╚═════╝ "
echo -e "${NC}"

# Check for --install flag
if [[ "$1" == "--install" ]]; then
    echo -e "${YELLOW}Installing dependencies...${NC}"

    # Check Node.js version
    if ! command -v node &> /dev/null; then
        echo -e "${RED}Error: Node.js not found. Install Node.js >= 18${NC}"
        exit 1
    fi

    NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
    if [ "$NODE_VERSION" -lt 18 ]; then
        echo -e "${RED}Error: Node.js >= 18 required (found v$NODE_VERSION)${NC}"
        exit 1
    fi

    # Check Claude CLI
    if ! command -v claude &> /dev/null; then
        echo -e "${YELLOW}Installing Claude CLI...${NC}"
        npm install -g @anthropic-ai/claude-code
    fi

    # Install npm dependencies
    echo -e "${YELLOW}Installing npm packages...${NC}"
    npm install

    # Check for .env
    if [ ! -f ".env" ]; then
        echo -e "${YELLOW}Creating .env from template...${NC}"
        cp .env.example .env
        echo -e "${RED}IMPORTANT: Edit .env with your Discord bot token and guild ID${NC}"
        echo -e "${YELLOW}Run './WIRED_START' again after configuring .env${NC}"
        exit 0
    fi

    echo -e "${GREEN}Installation complete!${NC}"
    exit 0
fi

# Check for .env
if [ ! -f ".env" ]; then
    echo -e "${RED}Error: .env not found${NC}"
    echo -e "${YELLOW}Run './WIRED_START --install' first${NC}"
    exit 1
fi

# Check dependencies
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}Dependencies not installed. Running npm install...${NC}"
    npm install
fi

# Start the daemon
echo -e "${GREEN}Starting WIRED system...${NC}"
echo ""

# Option 1: Direct node (foreground)
if [[ "$1" == "--foreground" ]] || [[ "$1" == "-f" ]]; then
    node core/daemon.js
    exit 0
fi

# Option 2: PM2 (background with auto-restart)
if command -v pm2 &> /dev/null; then
    echo -e "${YELLOW}Using PM2 for process management...${NC}"

    # Stop existing if running
    pm2 stop WIRED 2>/dev/null || true
    pm2 delete WIRED 2>/dev/null || true

    # Start fresh
    pm2 start core/daemon.js --name WIRED --interpreter node

    echo ""
    echo -e "${GREEN}WIRED is running in background!${NC}"
    echo ""
    echo "Commands:"
    echo "  pm2 logs WIRED      - View logs"
    echo "  pm2 stop WIRED      - Stop"
    echo "  pm2 restart WIRED   - Restart"
    echo ""
else
    echo -e "${YELLOW}PM2 not found. Running in foreground...${NC}"
    echo -e "${YELLOW}Install PM2 for background mode: npm install -g pm2${NC}"
    echo ""
    node core/daemon.js
fi
